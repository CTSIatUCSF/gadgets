<?xml version="1.0" encoding="UTF-8"?>
<Module>
	<ModulePrefs title="External Collaborators"
				 description="External Collaborators" width="190">
        <Require feature="opensocial-0.9" />
		<Require feature="dynamic-height" />
		<Require feature="osapi" />
		<Require feature="orng" />
		<Require feature="jsonld" />
        <Require feature="views" />
		<Require feature="start-hidden" />
	</ModulePrefs>

	<!-- ==================== START COMBINED VIEWS ==================== -->

    <Content type="html" view="verify, small, canvas">
    <![CDATA[	
    <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.4/jquery.js"></script>    
    <script type="text/javascript" src="js/environment.js" ></script>
    <script type="text/javascript" src="js/ontology.js" ></script>
    <script type="text/javascript" src="js/jsonld.js" ></script>   	
    <link rel="stylesheet" href="css/gadget.css" type="text/css" media="screen, projection" >
    <link rel="stylesheet" href="css/inst.css" type="text/css" media="screen, projection" >
	<script type="text/javascript">	        
		var COLLABORATED_ON = R2R('collaboratedOn');
	
		function getProductionURI(uri) {
			if (uri.indexOf("http://stage-profiles.ucsf.edu/profiles200") !== -1) {
				return uri.replace("http://stage-profiles.ucsf.edu/profiles200", "http://profiles.ucsf.edu");
			}
			else if (uri.indexOf("http://profilesstage.sc-ctsi.org") !== -1) {
				return uri.replace("http://profilesstage.sc-ctsi.org", "http://profiles.sc-ctsi.org");
			}
			return uri;
		}
			
		function readData(callback) {
			osapi.jsonld.getOwnerProperties([PRNS('fullName')]).execute(function(result) {
				if (!result.error) {
					$("#see-all").data("ownerURI", getProductionURI(result.uris[0])).show();
					var params = {};
					params[gadgets.io.RequestParameters.METHOD] = gadgets.io.MethodType.GET;
					var url = 'http://stage-r2r.ucsf.edu/crosslinks/coauthors?researcherURI=' + getProductionURI(result.uris[0]) + '&format=JSON-LD';
					gadgets.io.makeRequest(url, callback, params);
				}
			}); /* end osapi.appdata.get */			
		}
		
		function gadgetEventTrack(action, label, value) {		
			var message = {'action' : action};
			if (label) {message.label = label;}
			if (value) {message.value = value;}
			
			gadgets.orng.reportGoogleAnalyticsEvent(message);
		}	
		
		function getLabelValue(person) {
			var label = person[RDFS('label')];
			return label['@value'] ? label['@value'] : label;			
		}
				
    </script>
	]]>
	</Content>
    <Content type="html" view="small" preferred_width="190" preferred_height="290">
	<![CDATA[<!--HTML-->
    <!DOCTYPE html>
    
	<script type="text/javascript">
	
		// ========================================		
		function displayData(collaboratorsStr) {
			//var collaborators = gadgets.json.parse(collaboratorsStr.data);				
			// if links data exists
			var peopleFrame = gadgets.json.parse('[{"http://ucsf.edu/ontology/r2r#contributedTo": {}}]');
			//var peopleFrame = gadgets.json.parse('[{"@type": "http://xmlns.com/foaf/0.1/Person"}]');
			jsonld.frame(gadgets.json.parse(collaboratorsStr.data), peopleFrame, function(err, collaborators) {				
				if (collaborators && collaborators['@graph'] && collaborators['@graph'].length) {
					collaborators = collaborators['@graph'];
					// need to tell container that it is OK to show us
					gadgets.orng.showGadget();

					// put ones with the most publications at the top, since these are all shared publications
					collaborators.sort(function(a, b) {
						return getPropertyAsArray(b, COLLABORATED_ON).length - getPropertyAsArray(a, COLLABORATED_ON).length;
					});
										
					var list_data = "<div><span class='passiveSectionHeadDescription'>People at other institutions who have partnered with this person.</span>";					
					for (var i = 0; i<5 && i< collaborators.length;i++) {
						var person = collaborators[i];
						list_data += '<div class="col-item">';
						var imageURL = person[R2R('thumbnail')] || person[PRNS('mainImage')] || ENV_PROFILES_URL + "/Profile/Images/default_img.png";
						if (imageURL) {
							list_data += '<div class="thumbnail"><img src="' + imageURL + '" /></div>';
						} 
												
						list_data += "<a href='" + person['@id'] + "' target='_blank'> " + getLabelValue(person) + "</a>";
						list_data += "</div>";
						
					}
	       			// close the table
	       			list_data += "</div>";
	                  
	          		// put appdata table markup in designated div
					$("#collaborators_list").append(list_data);					
					$("#see-all span").text(collaborators.length);
					
	          		setTimeout(function(){
						var h = $("#collaborators_list").height() + 30;
						gadgets.window.adjustHeight(h);
			    	}, 1);
				}				
			});
		}
	
	   	gadgets.util.registerOnLoadHandler(function() {
			readData(displayData);
	    	$(document).ready(function () {
	    		$("#see-all").click(function(event) {
			        event.preventDefault();
			        var ownerURI = $("#see-all").data("ownerURI");
			        gadgetEventTrack('go_to_see_all', ownerURI);
			    	gadgets.views.requestNavigateTo('canvas', {}, ownerURI);	
	    		});
	   			$(".col-item a").live("click", function() {
	   				gadgetEventTrack('go_to_collaborator_from_small', $(this).attr("href"));
	   			});
	    		
	    	});
			
		});
    </script>
    
    <style>
    	.col-item{ min-height:22px; } 
	#see-all, #see-all span { font-size: 11px; font-weight: bold; }
    </style>

    <div id="collaborators_list"></div>     
    <div>
    	<a id="see-all" href="#" style="display:none">
    		<img style="margin-right:0;position:relative;top:1px;border:0" src="images/icon_squareArrow.gif" width="11" height="11"/>
    		See all (<span></span>) people
    	</a>
    </div>	
    
    ]]></Content>
    <Content type="html" view="verify">
    <![CDATA[	
   	<script type="text/javascript">	    
   		function checkData() {
   			// see if we already have this person/app combination internally in the system
   			osapi.orng.getAppInstance().execute(function(result) {
   				// if we do NOT have this in the system, then automatically add this to the persons if they have data from the service
   				if (typeof result !== 'string') {
					readData(registerApp); 					
   				}
   			});
   		}
   	    
		function registerApp(collaboratorsStr) {
			//var collaborators = gadgets.json.parse(collaboratorsStr.data);				
			// if links data exists
			var peopleFrame = gadgets.json.parse('[{"http://ucsf.edu/ontology/r2r#contributedTo": {}}]');
			//var peopleFrame = gadgets.json.parse('[{"@type": "http://xmlns.com/foaf/0.1/Person"}]');
			jsonld.frame(gadgets.json.parse(collaboratorsStr.data), peopleFrame, function(err, collaborators) {				
				if (collaborators && collaborators['@graph'] && collaborators['@graph'].length) {
					// need to tell container that it is OK to show us
					osapi.orng.addAppToOwner().execute(function(result) {
					});
				}
				else {
					// this does a "hard delete" and removes the app instance
					osapi.orng.removeAppFromOwner().execute(function(result) {
					});					
				}				
			});
		}

	   	gadgets.util.registerOnLoadHandler(checkData);
    </script>
	]]>
	</Content>
    <Content type="html" view="canvas" preferred_height="120" preferred_width="800">
    <![CDATA[
	   	<script type="text/javascript">
	   		var map;
		   	function loadScript() {
		  		var script = document.createElement('script');
			  	script.type = 'text/javascript';
			  	script.src = 'https://maps.googleapis.com/maps/api/js?v=3.exp&' +'callback=initialize';
			  	document.body.appendChild(script);
			}
				    
			function initialize() {
		   		var mapOptions = {
		          center: new google.maps.LatLng(39.622, -98.571),
		          zoom: 3
		        };
		        map = new google.maps.Map(document.getElementById("map-canvas"), mapOptions);
		        				
	    	}		   	
			function readData2(ownerUri, callback) {
				var params = {};
				params[gadgets.io.RequestParameters.METHOD] = gadgets.io.MethodType.GET;
				var url = 'http://stage-r2r.ucsf.edu/crosslinks/coauthors?researcherURI=' + getProductionURI(ownerUri) + '&format=JSON-LD';
				gadgets.io.makeRequest(url, callback, params);
			}
	    	
	    	var publications = {};
   	    	function loadPubs(callback) {
				var options = {};
				options.output = "full";            	  
		    	osapi.jsonld.getOwner(options).execute(function(data) {
		    		// in this case the owner will be the first and only item returned
		    		framePerson(data, function(owner) {
			    		var publications = owner[VIVO('authorInAuthorship')];
			    		if (publications instanceof Array) {
				    		for (var i in publications) {
				    			var pub = publications[i][VIVO('linkedInformationResource')];
				    			if(pub) {
				    				loadPub(pub);
				    			}					    						    			
				    		}
			    		}
			    		else if (publications) {
			    			var pub = publications[VIVO('linkedInformationResource')];
			    			loadPub(pub);
			    		}
			    		
			    		if(callback) {
			    			var ownerUri = owner['@id'];
			    			readData2(ownerUri, callback);
			    		}
		    		});
	   	    	});
  	    	};	
  	    	    			   	    	
	      	function loadPub(pub) {
				// check if this is an object first!
				if (pub == null || typeof pub != 'object') {
					return;
				}
				var publication = {};
	      		publication.id = pub['@id'].substring(pub['@id'].lastIndexOf('/') +1);

				publication.authorList = pub[PRNS('hasAuthorList')];
				publication.publicationVenue = pub[PRNS('hasPublicationVenue')];
				publication.pd = pub[PRNS('publicationDate')];
	      		publication.year = pub[PRNS('year')];
				publication.label = getLabelValue(pub);
				publication.pmid = pub[BIBO('pmid')]; 
				
				publication.title = publication.authorList + '; <span class="label">' + publication.label + '</span>; ' + publication.publicationVenue + '; ' + publication.year;
				publications[publication.pmid] = publication;	 
	      	}	      	
	    	
	    	function findPublication(pmUrl) {
	    		var id = getPubId(pmUrl);
	    		return publications[id];
	    	}
	    	
	    	function getPubId(pmUrl) {
	    		var parts = pmUrl.split("/");
	    		return parts[parts.length-1];
	    	}
	    	
	    	var CONTRIBUTED_TO = R2R('contributedTo');
	    	function getPubCount(person) {
				var pubs = person[CONTRIBUTED_TO];
	    		if(pubs instanceof Array) {
	    			return pubs.length;
	    		}
	    		
	    		return 1;
	    	}
	    	
		   	gadgets.util.registerOnLoadHandler(function() {		   	
		   		gadgets.window.adjustHeight(900);
		   		gadgets.orng.showGadget();
		   		loadScript();
		   		
		   		$(document).ready(function () {		   			
		   			$("a.col-pubs").live("click", function() {
		   				gadgetEventTrack('go_to_coauthored_papers', $(this).attr("href"));
		   			});
		   			
		   			$("a.col-name").live("click", function() {
		   				gadgetEventTrack('go_to_collaborator_from_canvas', $(this).attr("href"));
		   			});
		   		});
		   		
				loadPubs(function(collaboratorsStr) {
					var peopleFrame = gadgets.json.parse('[{"http://ucsf.edu/ontology/r2r#contributedTo": {}}]');
					jsonld.frame(gadgets.json.parse(collaboratorsStr.data), peopleFrame, function(err, collaborators) {				
						if (collaborators && collaborators['@graph'] && collaborators['@graph'].length) {
							collaborators = collaborators['@graph'];
							// need to tell container that it is OK to show us
							gadgets.orng.showGadget();
		
							// put ones with the most publications at the top, since these are all shared publications
							collaborators.sort(function(a, b) {
								return getPubCount(b) - getPubCount(a);
							});
									
							$(".total-count").text(collaborators.length);	                  
								
							for (var i = 0; i< collaborators.length;i++) {
								var person = collaborators[i];
								var imageURL = person[R2R('thumbnail')] || person[PRNS('mainImage')] || ENV_PROFILES_URL + "/Profile/Images/default_img.png";
								
								var name = getLabelValue(person);
								var webSite = person[R2R('fromRNWebSite')];
								var lat = webSite[PRNS('latitude')];
								var long = webSite[PRNS('longitude')];
								var university = getLabelValue(webSite);
												
						        var myLatlng = new google.maps.LatLng(lat, long);
						        var marker = new google.maps.Marker({
				    				position: myLatlng,
				    				map: map,
				    				title: university
								});
								
								var profileUrl=person['@id'];
								var pmUrl = "pubId";
								
								var pubs = person[R2R('contributedTo')];
								var pubs_count = 1;
								if(pubs instanceof Array) {
									pubs_count = pubs.length;
									pmUrl = "http://www.ncbi.nlm.nih.gov/pubmed/?term="									
									for(var p=0;p<pubs.length;p++) {
										pmUrl += getPubId(pubs[p]['@id']) + ",";
									}
								}
								else {
									pmUrl = pubs['@id'];
								}
								
								var pub = null;//findPublication(pmUrl);
								
								addColoborator(name, profileUrl, imageURL, webSite, pmUrl, pubs_count, pub?pub.title:"", university);								
							}									
						}				
					});
				});		   		 
		   	});	
		   			   	
		   	function addColoborator(name, profileUrl, imageURL, webSite, pmUrl, pubs_count, pubTitle, university) {
		   		var html = '<div class="col">';
		   		    html +='<div><div class="thumbnail"><img src="' + imageURL + '"></img></div><a href="' + profileUrl + '" target="_blank" class="col-name">'+name+'</a><span class="org">'+university+'</span>';
		   		    
		   		    html +='. <a href="' + pmUrl + '" target="_blank" class="col-pubs">See '+ pubs_count +' coauthored papers in PubMed</a>';
		   		    
		   		    html +='</div><div style="clear:both"/></div>';
		   		    
		   		$("#coll-list").append(html);    
		   	}	   	 
	    </script>

	    <style type="text/css">
	    	#map-canvas { height: 450px}
	    	
	    	.content{width: 600px;margin-left: 100px;}
	    	.map-wrap{width:600px;height: 450px; margin-bottom: 20px;}
	    	.list-wrap{font-size: 13px;line-height: 20px;}	    	 
	    	.title{font-weight: bold; color: #666; } 
	    	.descr{margin: 10px; }
	    	#coll-list {margin-left: 10px; height: 300px; overflow-y: auto;}
	    	.col {margin-bottom: 5px;}
	    	.col div {padding-top: 4px;}
	    	.org {margin-left: 10px;} 
	    	.pm-title{margin-left: 30px; width: 500px;}
	    	.pm-link{margin-left: 50px;}
		.thumbnail { margin-right: 4px; }
	    </style>
	    
   		<div class="content">
   			<div class="map-wrap">	
	   			<div id="map-canvas"></div>
	   		</div>		
   			<div class="list-wrap">
   				<div class="title">External Collaborators (<span class="total-count">0</span>) found</div>
   				<div class="descr">External Collaborators are people at other institutions who have published with this person. They are sorted by most shared publications to least. Click on a collaborator's name to open their profile page at their institution in a new window. <strong>Please note</strong>: Data is not available from all institutions so this list may be incomplete.</div>
   				<div id="coll-list">
   				</div>
	   		</div>	
	   		<div class="debug"></div>	
   		</div>
	]]>
	</Content>
</Module>
