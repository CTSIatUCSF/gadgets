<?xml version="1.0" encoding="UTF-8"?>
<Module>
    <ModulePrefs
            title="Academic Senate Committee Service"
            description="Academic Senate Committee Service">
		<OAuth2>
		  <Service name="academicSenateAPI"/>
		</OAuth2>            
        <Require feature="opensocial-0.9" />
        <Require feature="views" />
        <Require feature="osapi" />
        <Require feature="jsonld"/>
        <Require feature="orng"/>
        <Require feature="dynamic-height" />
        <Require feature="start-hidden"/>
    </ModulePrefs>
    
    <Content type="html" view="verify, default, home, profile"><![CDATA[
        <!DOCTYPE html>            
        <link rel="stylesheet" href="css/gadget.css" type="text/css" media="screen, projection" >
        <link rel="stylesheet" href="css/inst.css" type="text/css" media="screen, projection" >     
        <script type="text/javascript" src="js/jquery-1.11.1.min.js"></script>
        <script type="text/javascript" src="js/environment.js" ></script>
        <script type="text/javascript" src="js/os.js" ></script>
        <script type="text/javascript" src="js/ontology.js" ></script>
        <script type="text/javascript" src="js/jquery.blockUI-2.66.0.js"></script>    
        <script type="text/javascript" src="js/async.min.js"></script>    
        
        <script type="text/javascript">
			var UCSF = UCSF || {};
		    UCSF.SENATE_SERVICE_URL = "https://senateserviceportal.ucsf.edu/api/profile/";
			
            function getAPIData(url, callback){
                var params = {};
                params[gadgets.io.RequestParameters.METHOD] = gadgets.io.MethodType.GET;
				params[gadgets.io.RequestParameters.AUTHORIZATION] 		  = gadgets.io.AuthorizationType.OAUTH2;
				params[gadgets.io.RequestParameters.OAUTH_SERVICE_NAME] = "academicSenateAPI";
				params[gadgets.io.RequestParameters.REFRESH_INTERVAL] 	= "0";				
                params[gadgets.io.RequestParameters.CONTENT_TYPE] = gadgets.io.ContentType.TEXT;
				params[gadgets.io.RequestParameters.HEADERS] =  {"Accept" : "application/json"};
                gadgets.io.makeRequest(url, function(result) {
                    if(result && result.text ) {
                        return callback(null, result.text);
                    }
                    return callback();   
                }, params);
            }
			function loadData(callback) {
				osapi.people.getOwner().execute(function(result) {
					if (result && result.internalUsername) {
						var senateUrl = UCSF.SENATE_SERVICE_URL + result.internalUsername + "?fields=email,committees,awards"; 
						getAPIData(senateUrl, function(err, result) {
							callback(err, jQuery.parseJSON(result))
						});
					}
					else {
						callback('cannot get the gadget owner')
					}
				})	  
			}
			function renderData(data) {
			    if(data && data.committees) {
					data.committees.forEach(function(committee) {
						committee.service.forEach(function(service) {
							var startDate = new Date(service.start_date);
							var endDate = new Date(service.end_date);
							var html = '<tr>' + 
									   '  <td class="c-title">'+committee.title+'</td>' + 
									   '  <td class="c-role">'+service.role + '</td>' + 
									   '  <td class="c-date">'+ startDate.getFullYear() + '-' + endDate.getFullYear() + '</td>' + 
									   '</tr>';
							$('.committee-list table').append(html);
						});
					});
					$('.committee-list').show();
				}
			}
            
            function getOwner(callback) {
              var nodeId;
              
              osapi.jsonld.getOwner().execute(function(result) {
                  if (result.error) { 
                      callback();
                  } else {    
                      framePerson(result, function(owner) {
                          callback({
                            nodeId: mapNodeId(result.uris[0].substring(result.base.length)),
                            fullName: owner[PRNS('fullName')]
                          });
                      });                                                     
                  }               
              });                                          
            }            
        </script>        
		
        <style>
            #senate-committees {margin-top: 10px;}
			.committee-list {height: 200px; overflow-y: auto;margin-top: 20px; border: 1px solid slategray;}
			.committee-list table {margin: 10px;}
			.committee-list td {padding: 5px;}
			.c-date {width: 70px;}
        </style>
		
   ]]></Content>
        
   <Content type="html" view="verify"><![CDATA[
    <script type="text/javascript">
      function registerApp(register) {
        if (register) {
          osapi.orng.addAppToOwner().execute(function(result) {
          });
        }
        else {            
          osapi.orng.removeAppFromOwner().execute(function(result) {
          });         
        }
      }
    
      function checkData() {
			loadData(function(err, result) {
				registerApp(results && results.committees && results.committees.length > 0)
			});	
      }
      
      gadgets.util.registerOnLoadHandler(checkData);
    </script>   
   ]]></Content>
        
    <Content type="html" view="home"  preferred_width="700" preferred_height="300"><![CDATA[    
        <!DOCTYPE html>
        <script type="text/javascript">
            $(document).ready(function () {
                $("#senate-committees").block({ message: "Loading..." });
            });             
            gadgets.util.registerOnLoadHandler(function() {
				loadData(function(err, result) {
					gadgets.orng.showGadget();
					if(result) {
						renderData(result);						
						gadgets.window.adjustHeight($('.committee-list').height() + 100);
						$("#senate-committees").unblock();
					}
				});
            });
        </script>        
                
        <div id="senate-committees">
			<div class="sc-title">
				The information in this section comes from the Academic Senate Committee on Committees. If there are errors or omissions, please contact <a href="mail-to:emailcommittee@ucsf.edu">emailcommittee@ucsf.edu</a> to make corrections.
			</div>    
			<div class="committee-list" style="display:none">
				<table></table>
			</div>
        </div>
    ]]></Content>
    
    <Content type="html" view="profile" preferred_width="670" preferred_height="175"><![CDATA[
        <!DOCTYPE html>
        <link rel="stylesheet" href="css/gadget.css" type="text/css" media="screen, projection" >
        <link rel="stylesheet" href="css/inst.css" type="text/css" media="screen, projection" >
        <script type="text/javascript">
            
            gadgets.util.registerOnLoadHandler(function() {
                $(document).ready(function () {
					loadData(function(err, result) {
						gadgets.orng.showGadget();
						if(result) {
							renderData(result);						
							gadgets.window.adjustHeight($('.committee-list').height() + 50);
						}
						$("#senate-committees").unblock();
					});
                });             
            });            
        </script>        
        
        <div id="senate-committees">
			<div class="committee-list" style="display:none">
				<table></table>
			</div>
        </div>
    ]]></Content>
</Module>