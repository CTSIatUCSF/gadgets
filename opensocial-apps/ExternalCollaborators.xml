<?xml version="1.0" encoding="UTF-8"?>
<Module>
	<ModulePrefs title="External Collaborators"
				 description="External Collaborators" width="190">
        <Require feature="pubsub-2" />
		<Require feature="dynamic-height" />
		<Require feature="osapi" />
		<Require feature="orng" />
		<Require feature="start-hidden" />
	</ModulePrefs>

	<!-- ==================== START COMBINED VIEWS ==================== -->

	<Content type="html">
	<![CDATA[<!--HTML-->
    <!DOCTYPE html>
    
	<!-- #includes -->
	<link rel="stylesheet" href="css/gadget.css" type="text/css" media="screen, projection" >
    <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.4/jquery.js"></script>    
    <script type="text/javascript" src="js/environment.js" ></script>
    
	<style>
    	.links_title { font-family:Verdana, Arial; font-size: 14px; }
    	.links_body { font-family:Arial; font-size: 12px; }
    	.links_credit { font-family:Arial; font-size:10px; }
	.links_save_button { height:20px; font-size:11px; } 
    	a, a:visited { color: #0088CC; text-decoration: none; }
    	a:hover { color: #005580; text-decoration: underline; }
    </style>

    <div id="collaborators_list" style="padding:0px 0px 10px 20px;"></div>     
    	
	<script type="text/javascript">
	
		function getProductionURL(url) {
			if (url.indexOf("http://stage-profiles.ucsf.edu/profiles200") !== -1) {
				return url.replace("http://stage-profiles.ucsf.edu/profiles200", "http://profiles.ucsf.edu");
			}
			return url;
		}
			
		function readData(callback) {
			osapi.people.getOwner().execute(function(result){
				if (!result.error) {
					var params = {};
					params[gadgets.io.RequestParameters.METHOD] = gadgets.io.MethodType.GET;
					var url = 'http://64.54.132.20/crosslinks/coauthors?authorURL=' + getProductionURL(result.profileUrl) + '&format=JSON';
					gadgets.io.makeRequest(url, callback, params);
				}
			}); /* end osapi.appdata.get */			
		}
		// ========================================		
	
	
		// ========================================
		
		function displayData(collaboratorsStr) {
			var collaborators = gadgets.json.parse(collaboratorsStr.data);				
			// if links data exists
			if (collaborators && collaborators.length) {
				// need to tell container that it is OK to show us
				gadgets.orng.showGadget();
									
				var list_data = "<ul>";
				
                var includedURLs = [];
					for (i in collaborators) {
						var person = collaborators[i];
						if (includedURLs .indexOf(person.URL) == -1) {
						includedURLs.push(person.URL);
						list_data += "<li>";
						var imageURL = person.thumbnailURL || person.imageURL || ENV_PROFILES_URL + "/Profile/Images/default_img.png";
						if (imageURL) {
							list_data += "<img src='" + imageURL + "' width='20'>&nbsp;";
						} 
						list_data += "<a href='" + person.URL + "' target='_blank' onClick=\"gadgetEventTrack('go_to_website', '" + 
							person.URL + "')\"> " + person.firstName + " " + person.lastName + "</a>";
						list_data += "</li>";
					}
				}                    
       			// close the table
       			list_data += "</ul>";
                  
          		// put appdata table markup in designated div
				document.getElementById("collaborators_list").innerHTML=list_data;

				gadgets.window.adjustHeight();					
			}
		}
		// ========================================
		
		function gadgetEventTrack(action, label, value) {		
			var message = {'action' : action};
			if (label) {message.label = label;}
			if (value) {message.value = value;}
			
			gadgets.Hub.publish("analytics", message);
		}	
	
	   	gadgets.util.registerOnLoadHandler(function() {
	   		gadgets.rpc.register("remote_alert", function(msg, auth_key) {
            	if (auth_key == auth) {
                	alert(msg);
            	}
        	});
			readData(displayData)
		});
    </script>
    
    ]]></Content>
</Module>
