<?xml version="1.0" encoding="UTF-8"?>
<Module>
	<ModulePrefs title="External Collaborators"
				 description="External Collaborators" width="190">
		<Require feature="dynamic-height" />
		<Require feature="osapi" />
		<Require feature="orng" />
		<Require feature="jsonld" />
        <Require feature="views" />
		<Require feature="start-hidden" />
	</ModulePrefs>

	<!-- ==================== START COMBINED VIEWS ==================== -->

    <Content type="html" view="verify, profile">
    <![CDATA[	
    <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.4/jquery.js"></script>    
    <script type="text/javascript" src="js/environment.js" ></script>
    <script type="text/javascript" src="js/ontology.js" ></script>
    <script type="text/javascript" src="js/jsonld.js" ></script>
   	<script type="text/javascript">	        
		var COLLABORATED_ON = R2R('collaboratedOn');
	
		function getProductionURI(uri) {
			if (uri.indexOf("http://stage-profiles.ucsf.edu/profiles200") !== -1) {
				return uri.replace("http://stage-profiles.ucsf.edu/profiles200", "http://profiles.ucsf.edu");
			}
			return url;
		}
			
		function readData(callback) {
			osapi.jsonld.getOwnerProperties([PRNS('fullName')]).execute(function(result) {
				if (!result.error) {
					var params = {};
					params[gadgets.io.RequestParameters.METHOD] = gadgets.io.MethodType.GET;
					var url = 'http://stage-r2r.ucsf.edu/crosslinks/coauthors?researcherURI=' + getProductionURI(result.uris[0]) + '&format=JSON-LD';
					gadgets.io.makeRequest(url, callback, params);
				}
			}); /* end osapi.appdata.get */			
		}
		// ========================================		
    </script>
	]]>
	</Content>
    <Content type="html" view="profile" preferred_width="190">
	<![CDATA[<!--HTML-->
    <!DOCTYPE html>
    
	<!-- #includes -->
	<link rel="stylesheet" href="css/gadget.css" type="text/css" media="screen, projection" >
    
	<style>
    	.links_title { font-family:Verdana, Arial; font-size: 14px; }
    	.links_body { font-family:Arial; font-size: 12px; }
    	.links_credit { font-family:Arial; font-size:10px; }
	.links_save_button { height:20px; font-size:11px; } 
    	a, a:visited { color: #0088CC; text-decoration: none; }
    	a:hover { color: #005580; text-decoration: underline; }
    </style>

    <div id="collaborators_list" style="padding:0px 0px 10px 20px;"></div>     
    	
	<script type="text/javascript">
	
		// ========================================		
		function displayData(collaboratorsStr) {
			//var collaborators = gadgets.json.parse(collaboratorsStr.data);				
			// if links data exists
			var peopleFrame = gadgets.json.parse('[{"http://ucsf.edu/ontology/r2r#contributedTo": {}}]');
			//var peopleFrame = gadgets.json.parse('[{"@type": "http://xmlns.com/foaf/0.1/Person"}]');
			jsonld.frame(gadgets.json.parse(collaboratorsStr.data), peopleFrame, function(err, collaborators) {				
				if (collaborators && collaborators['@graph'] && collaborators['@graph'].length) {
					collaborators = collaborators['@graph'];
					// need to tell container that it is OK to show us
					gadgets.orng.showGadget();

					// put ones with the most publications at the top, since these are all shared publications
					collaborators.sort(function(a, b) {
						return getPropertyAsArray(b, COLLABORATED_ON).length - getPropertyAsArray(a, COLLABORATED_ON).length;
					});
										
					var list_data = "<ul>";					
					for (i in collaborators) {
						var person = collaborators[i];
						list_data += "<li>";
						var imageURL = person[R2R('thumbnail')] || person[PRNS('mainImage')] || ENV_PROFILES_URL + "/Profile/Images/default_img.png";
						if (imageURL) {
							list_data += "<img src='" + imageURL + "' width='20'>&nbsp;";
						} 
						
						list_data += "<a href='" + person['@id'] + "' target='_blank' onClick=\"gadgetEventTrack('go_to_website', '" + 
							person[FOAF('homepage')] + "')\"> " + person[RDFS('label')] + "</a>";
						list_data += "</li>";
					}
	       			// close the table
	       			list_data += "</ul>";
	                  
	          		// put appdata table markup in designated div
					document.getElementById("collaborators_list").innerHTML=list_data;
	
					gadgets.window.adjustHeight();					
				}				
			});
		}
		// ========================================
		
		function gadgetEventTrack(action, label, value) {		
			var message = {'action' : action};
			if (label) {message.label = label;}
			if (value) {message.value = value;}
			
			gadgets.orng.reportGoogleAnalyticsEvent(message);
		}	
	
	   	gadgets.util.registerOnLoadHandler(function() {
			readData(displayData)
		});
    </script>
    
    ]]></Content>
    <Content type="html" view="verify">
    <![CDATA[	
   	<script type="text/javascript">	    
   		function checkData() {
   			// see if we already have this person/app combination internally in the system
   			osapi.orng.getAppInstance().execute(function(result) {
   				// if we do NOT have this in the system, then automatically add this to the persons if they have data from the service
   				if (typeof result !== 'string') {
					readData(registerApp); 					
   				}
   			});
   		}
   	    
		function registerApp(collaboratorsStr) {
			//var collaborators = gadgets.json.parse(collaboratorsStr.data);				
			// if links data exists
			var peopleFrame = gadgets.json.parse('[{"http://ucsf.edu/ontology/r2r#contributedTo": {}}]');
			//var peopleFrame = gadgets.json.parse('[{"@type": "http://xmlns.com/foaf/0.1/Person"}]');
			jsonld.frame(gadgets.json.parse(collaboratorsStr.data), peopleFrame, function(err, collaborators) {				
				if (collaborators && collaborators['@graph'] && collaborators['@graph'].length) {
					// need to tell container that it is OK to show us
					osapi.orng.addAppToOwner().execute(function(result) {
					});
				}
				else {
					// this does a "hard delete" and removes the app instance
					osapi.orng.removeAppFromOwner().execute(function(result) {
					});					
				}				
			});
		}

	   	gadgets.util.registerOnLoadHandler(checkData);
    </script>
	]]>
	</Content>
</Module>
