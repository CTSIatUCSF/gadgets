<?xml version="1.0" encoding="UTF-8"?>
<Module>
	<ModulePrefs title="External Collaborators"
				 description="External Collaborators" width="190">
        <Require feature="opensocial-0.9" />
		<Require feature="dynamic-height" />
		<Require feature="osapi" />
		<Require feature="orng" />
		<Require feature="jsonld" />
        <Require feature="views" />
		<Require feature="start-hidden" />
	</ModulePrefs>

	<!-- ==================== START COMBINED VIEWS ==================== -->

    <Content type="html" view="verify, small, canvas">
    <![CDATA[	
    <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.4/jquery.js"></script>    
    <script type="text/javascript" src="js/environment.js" ></script>
    <script type="text/javascript" src="js/ontology.js" ></script>
    <script type="text/javascript" src="js/jsonld.js" ></script>   	
    <link rel="stylesheet" href="css/gadget.css" type="text/css" media="screen, projection" >
    <link rel="stylesheet" href="css/inst.css" type="text/css" media="screen, projection" >
	<script type="text/javascript">	        
		var COLLABORATED_ON = R2R('collaboratedOn');
	
		function getProductionURI(uri) {
			if (uri.indexOf("http://stage-profiles.ucsf.edu/profiles200") !== -1) {
				return uri.replace("http://stage-profiles.ucsf.edu/profiles200", "http://profiles.ucsf.edu");
			}
			else if (uri.indexOf("http://profilesstage.sc-ctsi.org") !== -1) {
				return uri.replace("http://profilesstage.sc-ctsi.org", "http://profiles.sc-ctsi.org");
			}
			return uri;
		}
			
		function readData(callback) {
			osapi.jsonld.getOwnerProperties([PRNS('fullName')]).execute(function(result) {
				if (!result.error) {
					$("#see-all").data("ownerURI", getProductionURI(result.uris[0])).show();
					var params = {};
					params[gadgets.io.RequestParameters.METHOD] = gadgets.io.MethodType.GET;
					var url = 'http://profiles.ucsf.edu/crosslinks/coauthors?researcherURI=' + getProductionURI(result.uris[0]) + '&format=JSON';
					gadgets.io.makeRequest(url, callback, params);
				}
			}); /* end osapi.appdata.get */			
		}
		
		function gadgetEventTrack(action, label, value) {		
			var message = {'action' : action};
			if (label) {message.label = label;}
			if (value) {message.value = value;}
			
			gadgets.orng.reportGoogleAnalyticsEvent(message);
		}	
		
		function getLabelValue(person) {
			var label = person[RDFS('label')];
			return label['@value'] ? label['@value'] : label;			
		}
				
		function parseCollaborators(collaboratorsStr) {
			var colArr = gadgets.json.parse(collaboratorsStr.data).results.bindings;
			var colMap = {};

			for (var i = 0; i < colArr.length; i++) {
				if (colMap[colArr[i].researcherURI.value]) {
					colMap[colArr[i].researcherURI.value].contributedWork.push(colArr[i].contributedWork.value);
				}
				else {
					var person = {};
					person.researcherURI = colArr[i].researcherURI.value;
					person.contributedWork = [];
					person.contributedWork[0] = colArr[i].contributedWork.value;
					person.image = colArr[i].thumbnail ? colArr[i].thumbnail.value : ENV_PROFILES_URL + "/Profile/Images/default_img.png";
					person.researcherHomePage = colArr[i].researcherHomePage ? colArr[i].researcherHomePage.value : colArr[i].researcherURI.value;
					person.label = colArr[i].researcherLabel.value;
					person.rns = {};
					person.rns.url = colArr[i].researchNetworkingSite.value;
					person.rns.label = colArr[i].affiliation.value;
					person.rns.lat = colArr[i].lat.value;
					person.rns.lon = colArr[i].lon.value;

					colMap[colArr[i].researcherURI.value] = person;
				}
			}
			var dataArray = [];
			for(var o in colMap) {
			    dataArray.push(colMap[o]);
			}
			return dataArray;
		}
	
    </script>
	]]>
	</Content>
    <Content type="html" view="small" preferred_width="190" preferred_height="290">
	<![CDATA[<!--HTML-->
    <!DOCTYPE html>
    
	<script type="text/javascript">

		// ========================================		
		function displayData(collaboratorsStr) {
			var collaborators = parseCollaborators(collaboratorsStr);
				if (collaborators && collaborators.length) {
					// need to tell container that it is OK to show us
					gadgets.orng.showGadget();

					// put ones with the most publications at the top, since these are all shared publications
					collaborators.sort(function(a, b) {
						return getPropertyAsArray(b, 'contributedWork').length - getPropertyAsArray(a, 'contributedWork').length;
					});
										
					var list_data = "<div><span class='passiveSectionHeadDescription'>People at other institutions who have partnered with this person.</span>";					
					for (var i = 0; i<5 && i< collaborators.length;i++) {
						var person = collaborators[i];
						list_data += '<div class="col-item">';
						list_data += '<div class="thumbnail"><img src="' + person.image + '" /></div>';						
						list_data += "<a href='" + person.researcherHomePage+ "' target='_blank'> " + person.label + "</a>";
						list_data += "</div>";
						
					}
	       			// close the table
	       			list_data += "</div>";
	                  
	          		// put appdata table markup in designated div
					$("#collaborators_list").append(list_data);					
					$("#see-all span").text(collaborators.length);
					
	          		setTimeout(function(){
						var h = $("#collaborators_list").height() + 70;
						gadgets.window.adjustHeight(h);
			    	}, 1);
			}				
		}
	
	   	gadgets.util.registerOnLoadHandler(function() {
			readData(displayData);
	    	$(document).ready(function () {
	    		$("#see-all").click(function(event) {
			        var ownerURI = $("#see-all").data("ownerURI");
			        gadgetEventTrack('go_to_see_all', ownerURI);
			    	gadgets.views.requestNavigateTo('canvas', {}, ownerURI);	
	    		});
	   			$(".col-item a").live("click", function() {
	   				gadgetEventTrack('go_to_collaborator_from_small', $(this).attr("href"));
	   			});
	    		
	    	});
			
		});
    </script>
    
    <style>
    	.col-item{ min-height:22px; } 
		.col-item a{margin-right: 3px;}
		#see-all, #see-all span { font-size: 11px; font-weight: bold; }
    </style>

    <div id="collaborators_list"></div>     
    <div style="border-bottom: 1px solid #CCC; padding: 4px 0 6px;">
        <a class="see-all" href="#" style="display:none"><img src="images/map.jpg" height="45" width="55"></img></a>
    	<a id="see-all" class="see-all dblarrow" style="display:none" href="#" >
    		See all (<span></span>) people
    	</a>
    </div>	
    
    ]]></Content>
    <Content type="html" view="canvas" preferred_height="120" preferred_width="800">
    <![CDATA[
	   	<script type="text/javascript">
	   		var map;
		   	function loadScript() {
		  		var script = document.createElement('script');
			  	script.type = 'text/javascript';
			  	script.src = 'https://maps.googleapis.com/maps/api/js?v=3.exp&' +'callback=initialize';
			  	document.body.appendChild(script);
			}
				    
			function initialize() {
		   		var mapOptions = {
		          center: new google.maps.LatLng(39.622, -98.571),
		          zoom: 3
		        };
		        map = new google.maps.Map(document.getElementById("map-canvas"), mapOptions);
		        				
	    	}		   	
			function readData2(ownerUri, callback) {
				var params = {};
				params[gadgets.io.RequestParameters.METHOD] = gadgets.io.MethodType.GET;
				var url = 'http://profiles.ucsf.edu/crosslinks/coauthors?researcherURI=' + getProductionURI(ownerUri) + '&format=JSON';
				gadgets.io.makeRequest(url, callback, params);
			}
	    	
	    	var publications = {};
   	    	function loadPubs(callback) {
				var options = {};
				options.output = "full";            	  
		    	osapi.jsonld.getOwner(options).execute(function(data) {
		    		// in this case the owner will be the first and only item returned
		    		framePerson(data, function(owner) {
			    		var publications = owner[VIVO('authorInAuthorship')];
			    		if (publications instanceof Array) {
				    		for (var i in publications) {
				    			var pub = publications[i][VIVO('linkedInformationResource')];
				    			if(pub) {
				    				loadPub(pub);
				    			}					    						    			
				    		}
			    		}
			    		else if (publications) {
			    			var pub = publications[VIVO('linkedInformationResource')];
			    			loadPub(pub);
			    		}
			    		
			    		if(callback) {
			    			var ownerUri = owner['@id'];
			    			readData2(ownerUri, callback);
			    		}
		    		});
	   	    	});
  	    	};	
  	    	    			   	    	
	      	function loadPub(pub) {
				// check if this is an object first!
				if (pub == null || typeof pub != 'object') {
					return;
				}
				var publication = {};
	      		publication.id = pub['@id'].substring(pub['@id'].lastIndexOf('/') +1);

				publication.authorList = pub[PRNS('hasAuthorList')];
				publication.publicationVenue = pub[PRNS('hasPublicationVenue')];
				publication.pd = pub[PRNS('publicationDate')];
	      		publication.year = pub[PRNS('year')];
				publication.label = getLabelValue(pub);
				publication.pmid = pub[BIBO('pmid')]; 
				
				publication.title = publication.authorList + '; <span class="label">' + publication.label + '</span>; ' + publication.publicationVenue + '; ' + publication.year;
				publications[publication.pmid] = publication;	 
	      	}	      	
	    	
	    	function findPublication(pmUrl) {
	    		var id = getPubId(pmUrl);
	    		return publications[id];
	    	}
	    	
	    	function getPubId(pmUrl) {
	    		var parts = pmUrl.split("/");
	    		return parts[parts.length-1];
	    	}
	    	
	    	var CONTRIBUTED_TO = FOAF('publications');
	    	function getPubCount(person) {
				var pubs = person[CONTRIBUTED_TO];
	    		if(pubs instanceof Array) {
	    			return pubs.length;
	    		}
	    		
	    		return 1;
	    	}
	    	
		   	gadgets.util.registerOnLoadHandler(function() {		   	
		   		gadgets.window.adjustHeight(900);
		   		gadgets.orng.showGadget();
		   		loadScript();
		   		
		   		$(document).ready(function () {		   			
		   			$("a.col-pubs").live("click", function() {
		   				gadgetEventTrack('go_to_coauthored_papers', $(this).attr("href"));
		   			});
		   			
		   			$("a.col-name").live("click", function() {
		   				gadgetEventTrack('go_to_collaborator_from_canvas', $(this).attr("href"));
		   			});
		   		});
		   		
				loadPubs(function(collaboratorsStr) {

					var collaborators = parseCollaborators(collaboratorsStr);
						if (collaborators && collaborators.length) {
							// need to tell container that it is OK to show us
							gadgets.orng.showGadget();
		
							// put ones with the most publications at the top, since these are all shared publications
							collaborators.sort(function(a, b) {
								return getPropertyAsArray(b, 'contributedWork').length - getPropertyAsArray(a, 'contributedWork').length;
							});
									
							$(".total-count").text(collaborators.length);	                  
								
							for (var i = 0; i< collaborators.length;i++) {
								var person = collaborators[i];
								var imageURL = person.image;
								
								var name = person.label;
								var webSite = person.rns.url;
								var lat = person.rns.lat;
								var long = person.rns.lon;
								var university = person.rns.label;

							if (lat && long) {												
							        var myLatlng = new google.maps.LatLng(lat, long);
							        var marker = new google.maps.Marker({
					    				position: myLatlng,
					    				map: map,
					    				title: university
									});
							}		
								var profileUrl = person.researcherHomePage;
								var pmUrl = "pubId";
								
								var pubs = person.contributedWork;
								var pubs_count = 1;
								if(pubs instanceof Array) {
									pubs_count = pubs.length;
									pmUrl = "http://www.ncbi.nlm.nih.gov/pubmed/?term="									
									for(var p=0;p<pubs.length;p++) {
										pmUrl += getPubId(pubs[p]) + ",";
									}
								}
								else {
									pmUrl = pubs['@id'];
								}
								
								var pub = null;//findPublication(pmUrl);
								
								addColoborator(name, profileUrl, imageURL, webSite, pmUrl, pubs_count, pub?pub.title:"", university);								
							}									
						}				
				});		   		 
		   	});	
		   			   	
		   	function addColoborator(name, profileUrl, imageURL, webSite, pmUrl, pubs_count, pubTitle, university) {
		   		var html = '<div class="col">';
		   		    html +='<div><div class="thumbnail"><img src="' + imageURL + '"></img></div><a href="' + profileUrl + '" target="_blank" class="col-name">'+name+'</a><span class="org">'+university+'</span>';
		   		    
		   		    html +='. <a href="' + pmUrl + '" target="_blank" class="col-pubs">See '+ pubs_count +' coauthored papers in PubMed</a>';
		   		    
		   		    html +='</div><div style="clear:both"/></div>';
		   		    
		   		$("#coll-list").append(html);    
		   	}	   	 
	    </script>

	    <style type="text/css">
	    	#map-canvas { height: 450px}
	    	
	    	.content{width: 600px;margin-left: 100px;}
	    	.map-wrap{width:600px;height: 450px; margin-bottom: 20px;}
	    	.list-wrap{font-size: 13px;line-height: 20px;}	    	 
	    	.title{font-weight: bold; color: #666; } 
	    	.descr{margin: 10px; }
	    	#coll-list {margin-left: 10px; height: 300px; overflow-y: auto;}
	    	.col {margin-bottom: 10px;padding-left: 20px; text-indent: -19px;}
	    	.org {margin-left: 10px;} 
	    	.pm-title{margin-left: 30px; width: 500px;}
	    	.pm-link{margin-left: 50px;}
			.thumbnail { margin: 2px 4px -2px 0; }
	    </style>
	    
   		<div class="content">
   			<div class="map-wrap">	
	   			<div id="map-canvas"></div>
	   		</div>		
   			<div class="list-wrap">
   				<div class="title">External Collaborators (<span class="total-count">0</span>) found</div>
   				<div class="descr">External Collaborators are people at other institutions who have worked with this person. They are sorted by most collaborations (publications, grants, etc.) to least. Click on a collaborator's name to open their profile page at their institution in a new window. <strong>Please note</strong>: Data is not available from all institutions so this list may be incomplete.</div>
   				<div id="coll-list">
   				</div>
	   		</div>	
	   		<div class="debug"></div>	
   		</div>
	]]>
	</Content>
</Module>
